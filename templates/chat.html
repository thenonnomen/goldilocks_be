{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Food Brand Assistant</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #343541;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            color: #ececf1;
            background-blend-mode: color;
            height: 100vh;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #202123;
            border-right: 1px solid #565869;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .new-chat-btn {
            background: transparent;
            border: 1px solid #565869;
            color: #ececf1;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #2a2b32;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            color: #ececf1;
            transition: background 0.2s;
            font-size: 14px;
        }

        .chat-item:hover {
            background: #2a2b32;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            padding: 20px 0;
            border-bottom: 1px solid #565869;
        }

        .message:last-child {
            border-bottom: none;
        }

        .message.user {
            background: #343541;
        }

        .message.assistant {
            background: #444654;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: #5436da;
        }

        .assistant .message-avatar {
            background: #19c37d;
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
        }

        .message-content h4 {
            margin-bottom: 10px;
            color: black;
        }

        .table-container {
            overflow-x: auto;
            margin: 15px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2b32;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #565869;
        }

        .data-table th {
            background: #40414f;
            font-weight: 600;
            color: black;
        }

        .data-table tr:hover {
            background: #40414f;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #565869;
            background: #343541;
        }

        .input-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .message-input {
            width: 100%;
            background: #40414f;
            border: 1px solid #565869;
            border-radius: 12px;
            padding: 12px 50px 12px 16px;
            color: white;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 200px;
        }

        .message-input:focus {
            outline: none;
            border-color: #5436da;
        }

        .send-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #5436da;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #6c5ce7;
        }

        .send-btn:disabled {
            background: #565869;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 2px solid #565869;
            border-top: 2px solid #5436da;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: #fff;
        }

        .welcome-message h2 {
            color: #fff;
            margin-bottom: 16px;
        }

        .model-selector {
            background: #40414f;
            border: 1px solid #565869;
            color: #ececf1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .error-message {
            background: #ff4444;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                width: 100%;
            }
        }

        .title {
            z-index: 99;
            text-align: center;
            padding: 10px;
            box-shadow: 3px 4px 8px -2px rgba(189, 181, 181, 0.81);
            -webkit-box-shadow: 3px 4px 8px -2px rgb(106 106 106 / 81%);
            -moz-box-shadow: 3px 4px 8px -2px rgba(189,181,181,0.81);
        }

        .logo {
            width: auto;
            object-fit: contain;
            height: 45px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <!-- <div class="sidebar">
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i>
                New Chat
            </button>
            
            <select class="model-selector" id="modelSelector">
                <option value="mistralai/devstral-small">Mistral DevStral Small</option>
                <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
                <option value="meta-llama/llama-3.3-8b">Llama 3.3 8B</option>
                <option value="meta-llama/llama-4-maverick">Llama 4 Maverick</option>
            </select>
            
            <div class="chat-history">
                <div class="chat-item">
                    <i class="fas fa-message me-2"></i>
                    Indian Brands Analysis
                </div>
                <div class="chat-item">
                    <i class="fas fa-message me-2"></i>
                    Mid-sized Companies Research
                </div>
            </div>
        </div> -->

        <!-- Main Content -->
        <div class="main-content">
            <div class="">

            </div>
            <div class="title">
                <div class="container d-flex justify-content-center align-items-center">
                    <div class="d-flex align-items-center">
                        <img class="logo" src="{% static 'images/bg-Photoroom.png' %}" alt="Logo">
                        <h3 class="mb-0">Goldilocks AI</h3>
                    </div>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-message">
                    <h2><i class="fas fa-robot me-2"></i>AI Assistant</h2>
                    <p>Ask me about Indian brands, market analysis, or company information.</p>
                    <p>I can provide detailed insights about mid-sized companies, revenue data, and market trends.</p>
                </div>
            </div>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div>AI is thinking...</div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Ask about Indian brands..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'aHR0cHM6Ly9vcGVucm91dGVyLmFpL2FwaS92MS9jaGF0L2NvbXBsZXRpb25z'; // Replace with your actual encoded URL
        
        let conversationHistory = [];

        // Initialize the application
        $(document).ready(function() {
            // Auto-resize textarea
            $('#messageInput').on('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Enter key to send message
            $('#messageInput').on('keypress', function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        function startNewChat() {
            conversationHistory = [];
            $('#messagesContainer').html(`
                <div class="welcome-message">
                    <h2><i class="fas fa-robot me-2"></i>AI Assistant</h2>
                    <p>Ask me about Indian brands, market analysis, or company information.</p>
                    <p>I can provide detailed insights about mid-sized companies, revenue data, and market trends.</p>
                </div>
            `);
        }

        function sendMessage() {
            const messageInput = $('#messageInput');
            const message = messageInput.val().trim();
            
            if (!message) return;

            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input
            messageInput.val('');
            messageInput.css('height', 'auto');
            
            // Show loading
            showLoading(true);
            
            // Send to API
            callAPI(message);
        }

        function addMessage(content, type) {
            const messagesContainer = $('#messagesContainer');
            
            // Remove welcome message if it exists
            messagesContainer.find('.welcome-message').remove();
            
            const avatarIcon = type === 'user' ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
                
            const messageHtml = `
                <div class="message ${type}">
                    <div class="message-avatar">
                        ${avatarIcon}
                    </div>
                    <div class="message-content">
                        ${content}
                    </div>
                </div>
            `;
            
            messagesContainer.append(messageHtml);
            messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
        }

        function showLoading(show) {
            if (show) {
                $('#loadingIndicator').show();
                $('#sendBtn').prop('disabled', true);
            } else {
                $('#loadingIndicator').hide();
                $('#sendBtn').prop('disabled', false);
            }
        }

        
        function callAPI(userMessage) {
    $.ajax({
        url: '/llm-chat/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ prompt: userMessage }),
        success: function(data) {
            const response = data.response;
            processAPIResponse(response, userMessage);
        },
        error: function(xhr, status, error) {
            processAPIResponse("Error: " + xhr.responseText, userMessage);
        }
    });
}



        function processAPIResponse(response, userMessage) {
            showLoading(false);
            
            // Store conversation
            conversationHistory.push({
                user: userMessage,
                assistant: response
            });
            
            // Format and display response
            const formattedResponse = formatResponse(response);
            addMessage(formattedResponse, 'assistant');
        }

        function formatResponse(response) {
            let formattedContent = '';
            
            // Check if response contains multiple model responses
            if (typeof response === 'string') {
                // Split by model response indicators
                const modelResponses = response.split('🔹 Response from ');
                
                modelResponses.forEach((modelResponse, index) => {
                    if (index === 0 && modelResponse.trim()) {
                        // First part (before any model responses)
                        formattedContent += `<p>${modelResponse.trim()}</p>`;
                    } else if (modelResponse.trim()) {
                        // Extract model name and content
                        const lines = modelResponse.split('\n');
                        const modelName = lines[0].replace(':', '');
                        const content = lines.slice(1).join('\n').trim();
                        
                        formattedContent += `
                            <div class="model-response" style="margin: 20px 0; padding: 15px; background: #2a2b32; border-radius: 8px;">
                                <h4 style="color: #5436da; margin-bottom: 10px;">
                                    <i class="fas fa-brain me-2"></i>${modelName}
                                </h4>
                                ${formatContent(content)}
                            </div>
                        `;
                    }
                });
            } else {
                formattedContent = formatContent(response);
            }
            
            return formattedContent;
        }

        function formatContent(content) {
            // Convert table data to HTML table
            if (content.includes('|') && content.includes('---')) {
                return formatTableContent(content);
            }
            
            // Format regular text content
            return content.split('\n').map(line => {
                line = line.trim();
                if (!line) return '<br>';
                if (line.startsWith('### ')) {
                    return `<h4 style="color: #fff; margin: 15px 0 10px 0;">${line.substring(4)}</h4>`;
                }
                if (line.startsWith('**') && line.endsWith('**')) {
                    return `<h5 style="color: #ececf1; margin: 10px 0 5px 0;">${line.slice(2, -2)}</h5>`;
                }
                if (line.match(/^\d+\./)) {
                    return `<div style="margin: 5px 0;">${line}</div>`;
                }
                return `<p style="margin: 8px 0;">${line}</p>`;
            }).join('');
        }

        function formatTableContent(content) {
            const lines = content.split('\n').filter(line => line.trim());
            let tableHtml = '';
            let inTable = false;
            let headers = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.includes('|') && !line.includes('---')) {
                    if (!inTable) {
                        // Start table
                        tableHtml += '<div class="table-container"><table class="data-table">';
                        headers = line.split('|').map(h => h.trim()).filter(h => h);
                        tableHtml += '<thead><tr>';
                        headers.forEach(header => {
                            tableHtml += `<th>${header}</th>`;
                        });
                        tableHtml += '</tr></thead><tbody>';
                        inTable = true;
                    } else {
                        // Table row
                        const cells = line.split('|').map(c => c.trim()).filter(c => c);
                        if (cells.length > 0) {
                            tableHtml += '<tr>';
                            cells.forEach(cell => {
                                tableHtml += `<td>${cell}</td>`;
                            });
                            tableHtml += '</tr>';
                        }
                    }
                } else if (line.includes('---')) {
                    // Skip separator line
                    continue;
                } else {
                    if (inTable) {
                        // End table
                        tableHtml += '</tbody></table></div>';
                        inTable = false;
                    }
                    
                    // Regular content
                    if (line) {
                        if (line.startsWith('### ')) {
                            tableHtml += `<h4 style="color: #fff; margin: 15px 0 10px 0;">${line.substring(4)}</h4>`;
                        } else if (line.match(/^\d+\./)) {
                            tableHtml += `<div style="margin: 5px 0;">${line}</div>`;
                        } else {
                            tableHtml += `<p style="margin: 8px 0;">${line}</p>`;
                        }
                    }
                }
            }
            
            if (inTable) {
                tableHtml += '</tbody></table></div>';
            }
            
            return tableHtml;
        }
    </script>
</body>
</html>